id: net.classicube.flatpak.client
runtime: org.freedesktop.Platform
runtime-version: '23.08'
sdk: org.freedesktop.Sdk
command: ClassiCubeLauncher
finish-args:
  - --socket=wayland
  - --socket=fallback-x11
  - --device=dri
  - --share=network
  - --share=ipc
  - --socket=pulseaudio
modules:
  - name: SDL3
    # Wouldn't work without doing this :(
    buildsystem: simple
    build-commands:
      - cmake -S . -B build -G Ninja -D SDL_HIDAPI_LIBUSB=ON -D CMAKE_INSTALL_PREFIX=${FLATPAK_DEST} -D SDL_RPI=OFF -D SDL_STATIC=OFF -D SDL_RPATH=OFF
      - cmake --build build
      - cmake --install build
    sources:
      - type: archive
        url: https://github.com/libsdl-org/SDL/releases/download/prerelease-3.1.0/SDL3-3.1.0.tar.xz
        sha256: 0eac19111cde216644fa70af953db3eaea06fad198b5f5a8bc899164768054e7
    cleanup:
      - /bin/sdl3-config
      - /include
      - /lib/libSDL3.la
      - /lib/libSDL3main.a
      - /lib/libSDL3main.la
      - /lib/libSDL3_test.a
      - /lib/libSDL3_test.la
      - /lib/cmake
      - /share/aclocal
      - /lib/pkgconfig
    modules:
      - name: libdecor
        buildsystem: meson
        config-opts:
          - '-Ddemo=false'
        sources:
          - type: archive
            url: https://gitlab.freedesktop.org/libdecor/libdecor/-/archive/0.2.2/libdecor-0.2.2.tar.gz
            sha256: 40a1d8be07d8b1f66e8fb98a1f4a84549ca6bf992407198a5055952be80a8525
        cleanup:
          - /include
          - /lib/pkgconfig

  - name: ClassiCube
    buildsystem: simple
    build-commands:
      - gcc -fno-math-errno src/*.c -o src/ClassiCube -rdynamic -lpthread -lGL -DCC_BUILD_SDL3 -DCC_BUILD_GLMODERN -DCC_BUILD_FLATPAK -L /app/lib -lSDL3
      - install -Dm755 src/ClassiCube -t ${FLATPAK_DEST}/bin
      - install -Dm755 ClassiCubeLauncher -t ${FLATPAK_DEST}/bin
      - install -Dm644 misc/linux/flatpak/net.classicube.flatpak.client.svg ${FLATPAK_DEST}/share/icons/hicolor/scalable/apps/net.classicube.flatpak.client.svg
      - install -Dm644 misc/linux/flatpak/net.classicube.flatpak.client.desktop ${FLATPAK_DEST}/share/applications/net.classicube.flatpak.client.desktop
      - install -Dm644 misc/linux/flatpak/net.classicube.flatpak.client.metainfo.xml ${FLATPAK_DEST}/share/metainfo/net.classicube.flatpak.client.metainfo.xml
    sources:
      - type: git
        url: https://github.com/ClassiCube/ClassiCube.git
      - type: script
        dest-filename: ClassiCubeLauncher
        commands:
         - mkdir -p ${XDG_DATA_HOME}/ClassiCube
         - cd ${XDG_DATA_HOME}/ClassiCube && exec /app/bin/ClassiCube "$@"